<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/jpeg" href="https://res.cloudinary.com/dij2fdtw4/image/upload/v1769602073/give_a_rosebud_favicon_in_red_please_xqnp4v.jpg">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4986542893990493" crossorigin="anonymous"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Secure checkout for Heart & Petal gifts. Complete your order for flowers, chocolates, and teddy bears with fast, safe delivery.">
  <title>Secure Checkout - Heart & Petal</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&family=Great+Vibes&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>emailjs.init('vaGZ6CuU7QPtw8dCI');</script>
  
  <!-- Core JavaScript Files (load before PayPal) -->
  <script src="js/error-handler.js"></script>
  <script src="js/mobile-menu.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/inventory.js"></script>
  <script src="js/discounts.js"></script>
  <script src="js/orders.js"></script>
  <script src="js/cart.js"></script>
</head>

<body class="bg-gray-50 font-montserrat">
  
  <!-- Free Delivery Banner -->
  <div class="bg-deep-red text-white text-center py-2 text-sm font-bold">
    FREE DELIVERY ON ALL ORDERS ACROSS THE USA!
  </div>

  <!-- Header -->
  <header class="bg-white/90 shadow sticky top-0 z-50">
    <div class="container mx-auto flex items-center justify-between py-3 px-4 md:px-6">
      <a href="index.html" class="flex items-center gap-1 md:gap-2 flex-shrink-0">
        <img src="assets/logofile.png" alt="Heart & Petal Logo" class="h-8 md:h-10 w-8 md:w-10 object-contain">
        <span class="font-playfair text-xl md:text-2xl text-deep-red tracking-wide hidden sm:inline">Heart & Petal</span>
      </a>
      <!-- Desktop Nav - Hidden on mobile -->
      <nav class="hidden lg:flex space-x-3 xl:space-x-6 text-sm md:text-lg items-center">
        <a href="index.html" class="hover:text-deep-red transition">Home</a>
        <a href="shop.html" class="hover:text-deep-red transition">Shop</a>
        <a href="about.html" class="hover:text-deep-red transition">About</a>
        <a href="faq.html" class="hover:text-deep-red transition">FAQ</a>
        <a href="checkout.html" class="hover:text-deep-red transition font-bold text-deep-red">Checkout</a>
        <a href="legal.html" class="hover:text-deep-red transition">Legal</a>
        <div class="relative group">
          <button class="hover:text-champagne-gold transition focus:outline-none text-sm md:text-base">Login | Register</button>
          <div class="absolute right-0 mt-2 w-48 bg-white border border-charcoal rounded shadow-lg opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition z-50">
            <a href="admin.html" class="block px-4 py-2 hover:bg-blush-pink/40 text-sm">Admin</a>
            <a href="customer-login.html" class="block px-4 py-2 hover:bg-blush-pink/40 text-sm">Customer</a>
          </div>
        </div>
      </nav>
      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="lg:hidden text-deep-red focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <!-- Cart Button -->
      <a href="checkout.html" class="ml-1 md:ml-2 lg:ml-4 bg-deep-red text-ivory px-1.5 md:px-4 py-1.5 md:py-2 rounded-lg font-great-vibes text-sm md:text-xl shadow hover:bg-red-700 transition flex items-center gap-0.5 md:gap-2 flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span class="hidden sm:inline">Cart</span>
      </a>
    </div>
    <!-- Mobile Menu - Hidden on desktop -->
    <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-charcoal max-h-96 overflow-y-auto">
      <a href="index.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">Home</a>
      <a href="shop.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">Shop</a>
      <a href="about.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">About</a>
      <a href="faq.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">FAQ</a>
      <a href="checkout.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40 font-bold">Checkout</a>
      <a href="legal.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">Legal</a>
      <a href="admin.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40 border-t">Admin</a>
      <a href="customer-login.html" class="block px-4 py-2 text-sm hover:bg-blush-pink/40">Customer Login</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    
    <h1 class="text-4xl font-playfair text-deep-red text-center mb-8">Secure Checkout</h1>

    <div class="grid lg:grid-cols-3 gap-8">
      
      <!-- Left Column: Customer Info & Shipping -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Customer Information Card -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">üìã</span> Customer Information
          </h2>
          
          <form id="checkout-form" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name *</label>
              <input type="text" id="checkout-name" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="John Doe">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Email Address *</label>
              <input type="email" id="checkout-email" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="john@example.com">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Phone Number *</label>
              <input type="tel" id="checkout-phone" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="(555) 123-4567">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Shipping Address *</label>
              <textarea id="checkout-address" required rows="3"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="123 Main St, Apt 4, City, State 12345"></textarea>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Special Instructions (Optional)</label>
              <textarea id="checkout-notes" rows="2"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="Any special delivery instructions..."></textarea>
            </div>
          </form>
        </div>

        <!-- Delivery Service Options -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">üöö</span> Delivery Service
          </h2>
          
          <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-4">
            <p class="text-sm font-bold text-green-800 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              FREE Standard Delivery on all orders across the USA!
            </p>
            <p class="text-xs text-gray-700 mt-1 ml-7">Standard delivery takes 3-5 business days. Express options available.</p>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Select Delivery Speed</label>
              <select id="checkout-shipping" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent bg-white">
                <option value="Standard Delivery (3-5 days)">Standard Delivery (3-5 days) - <span style="text-decoration: line-through; color: #999;">$9.99</span> FREE üíê</option>
                <option value="Express Delivery (1-2 days)">Express Delivery (1-2 days) - <span style="text-decoration: line-through; color: #999;">$19.99</span> FREE ‚ö°</option>
                <option value="Valentine's Day Guaranteed">Valentine's Day Guaranteed - <span style="text-decoration: line-through; color: #999;">$29.99</span> FREE üíù</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Preferred Delivery Date (Optional)</label>
              <input type="date" id="checkout-delivery-date" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deep-red focus:border-transparent"
                placeholder="Select delivery date">
            </div>
          </div>
        </div>

        <!-- Payment Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">üí≥</span> Payment Method
          </h2>
          
          <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-3">
              <span class="text-2xl">üîí</span>
              <div>
                <h3 class="font-bold text-blue-900">Secure PayPal Checkout</h3>
                <p class="text-sm text-blue-800">Your payment is processed securely through PayPal. No credit card information is stored on our servers.</p>
              </div>
            </div>
          </div>

          <!-- PayPal Button Container -->
          <div id="paypal-button-container" class="mt-6"></div>
          <div id="paypal-error" class="hidden mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg text-center">
            <p class="text-red-600 font-bold">‚ùå Payment System Error</p>
            <p class="text-gray-700 text-sm mt-2">PayPal failed to load. Please refresh the page.</p>
            <button onclick="location.reload()" class="mt-3 bg-deep-red text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
              Refresh Page
            </button>
          </div>
        </div>

      </div>

      <!-- Right Column: Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">üì¶</span> Order Summary
          </h2>

          <!-- Cart Items -->
          <div id="checkout-cart-items" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
            <!-- Cart items will be populated here -->
          </div>

          <!-- Discount Code Section -->
          <div class="border-t pt-4 mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Discount Code</label>
            <div class="flex gap-2">
              <input type="text" id="discount-code-input" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-deep-red"
                placeholder="Enter code">
              <button id="apply-discount-btn" 
                class="bg-deep-red text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition whitespace-nowrap">
                Apply
              </button>
            </div>
            <div id="discount-status" class="text-sm mt-2"></div>
          </div>

          <!-- Totals -->
          <div class="border-t pt-4 space-y-2">
            <div class="flex justify-between text-gray-700">
              <span>Subtotal:</span>
              <span id="cart-subtotal">$0.00</span>
            </div>
            <div class="flex justify-between text-gray-700">
              <span>Delivery:</span>
              <span class="text-green-600 font-semibold">FREE</span>
            </div>
            <div id="discount-row" class="flex justify-between text-green-600 hidden">
              <span>Discount:</span>
              <span id="cart-discount">-$0.00</span>
            </div>
            <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t">
              <span>Total:</span>
              <span id="cart-total">$0.00</span>
            </div>
          </div>

          <div class="mt-6 p-3 bg-gray-50 rounded-lg text-xs text-gray-600">
            <p class="flex items-center gap-2">
              <span>üîí</span> SSL Secure ‚Ä¢ Powered by PayPal ‚Ä¢ 256-bit Encryption
            </p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-deep-red text-white py-8 mt-12">
    <div class="container mx-auto px-6 text-center">
      <p class="font-playfair text-xl mb-2">Heart & Petal</p>
      <p class="text-sm">¬© 2026 Heart & Petal. All rights reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="legal.html" class="hover:underline text-sm">Privacy & Terms</a>
        <a href="faq.html" class="hover:underline text-sm">FAQ</a>
      </div>
    </div>
  </footer>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=ATV1zuqmwzmcXCuDMfIm9vY4ZhkVn3U9Lj_e8p4fI8rQb7XnEMEN_wapBZHCcpUjXp_IlQjitGWnLMXnDZEy8ILA01u_UTAuYacH4y7YNE6UG_gSkkMQ6hMLQxgt3oHa&currency=USD"></script>

  <!-- Checkout Logic -->
  <script>
    // Display cart items and totals
    function displayCheckoutCart() {
      const cart = getCart();
      const itemsContainer = document.getElementById('checkout-cart-items');
      const subtotalEl = document.getElementById('cart-subtotal');
      const discountEl = document.getElementById('cart-discount');
      const totalEl = document.getElementById('cart-total');
      const discountRow = document.getElementById('discount-row');

      console.log('üõí Cart contents:', cart);

      if (!cart || cart.length === 0) {
        itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Your cart is empty</p>';
        subtotalEl.textContent = '$0.00';
        totalEl.textContent = '$0.00';
        document.getElementById('paypal-button-container').innerHTML = 
          '<div class="text-center py-6 bg-yellow-50 border-2 border-yellow-300 rounded-lg"><p class="text-yellow-800 font-bold">üõí Your cart is empty</p><p class="text-gray-700 text-sm mt-2">Add items to your cart before checking out.</p><a href="shop.html" class="inline-block mt-3 bg-deep-red text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">Shop Now</a></div>';
        return;
      }

      // Display cart items
      itemsContainer.innerHTML = cart.map((item, index) => {
        const imageUrl = item.img || item.image || 'https://via.placeholder.com/64x64?text=No+Image';
        console.log(`üì¶ Item ${index}:`, item.name, 'Image:', imageUrl);
        
        return `
          <div class="flex items-center gap-3 pb-3 border-b">
            <img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded" onerror="this.onerror=null; this.src='https://via.placeholder.com/64x64?text=No+Image';">
            <div class="flex-1">
              <p class="font-semibold text-sm">${item.name}</p>
              ${item.variant ? `<p class="text-xs text-gray-500">${typeof item.variant === 'object' ? item.variant.name : item.variant}</p>` : ''}
              <p class="text-xs text-gray-600">Qty: ${item.quantity} √ó $${item.price.toFixed(2)}</p>
            </div>
            <p class="font-bold text-sm">$${(item.price * item.quantity).toFixed(2)}</p>
          </div>
        `;
      }).join('');

      // Calculate totals
      const subtotal = getCartTotal();
      const discount = parseFloat(localStorage.getItem('appliedDiscountAmount')) || 0;
      const total = Math.max(0, subtotal - discount);

      subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      totalEl.textContent = `$${total.toFixed(2)}`;

      if (discount > 0) {
        discountEl.textContent = `-$${discount.toFixed(2)}`;
        discountRow.classList.remove('hidden');
      } else {
        discountRow.classList.add('hidden');
      }
    }

    // Apply discount code
    document.getElementById('apply-discount-btn').addEventListener('click', function() {
      const code = document.getElementById('discount-code-input').value.trim().toUpperCase();
      const statusEl = document.getElementById('discount-status');

      if (!code) {
        statusEl.innerHTML = '<span class="text-red-600">‚ùå Please enter a code</span>';
        return;
      }

      const cart = getCart();
      const subtotal = getCartTotal();
      
      if (typeof applyDiscount === 'function') {
        const result = applyDiscount(code, cart, subtotal);
        
        if (result.success) {
          localStorage.setItem('appliedDiscountCode', code);
          localStorage.setItem('appliedDiscountAmount', result.discountAmount.toFixed(2));
          statusEl.innerHTML = `<span class="text-green-600">‚úÖ ${result.message}</span>`;
          displayCheckoutCart();
        } else {
          statusEl.innerHTML = `<span class="text-red-600">‚ùå ${result.message}</span>`;
        }
      } else {
        statusEl.innerHTML = '<span class="text-red-600">‚ùå Discount system not loaded</span>';
      }
    });

    // Validate form before payment
    function validateCheckoutForm() {
      const name = document.getElementById('checkout-name').value.trim();
      const email = document.getElementById('checkout-email').value.trim();
      const phone = document.getElementById('checkout-phone').value.trim();
      const address = document.getElementById('checkout-address').value.trim();

      if (!name || name.length < 2) {
        showError('Please enter a valid name');
        return false;
      }

      if (!email || !email.includes('@') || !email.includes('.')) {
        showError('Please enter a valid email address');
        return false;
      }

      if (!phone || phone.length < 10) {
        showError('Please enter a valid phone number');
        return false;
      }

      if (!address || address.length < 10) {
        showError('Please enter a complete shipping address');
        return false;
      }

      return true;
    }

    // Initialize PayPal Button
    function initPayPalButton() {
      if (!window.paypal) {
        console.error('‚ùå PayPal SDK not loaded');
        document.getElementById('paypal-error').classList.remove('hidden');
        return;
      }

      const cart = getCart();
      if (!cart || cart.length === 0) {
        return; // Empty cart message already shown
      }

      console.log('‚úÖ Initializing PayPal button');

      paypal.Buttons({
        style: {
          layout: 'vertical',
          color: 'gold',
          shape: 'rect',
          label: 'paypal'
        },

        createOrder: function(data, actions) {
          // Validate form first
          if (!validateCheckoutForm()) {
            return actions.reject();
          }

          const subtotal = getCartTotal();
          const discount = parseFloat(localStorage.getItem('appliedDiscountAmount')) || 0;
          const total = Math.max(0.01, subtotal - discount);

          console.log('üí∞ Creating order:', { subtotal, discount, total });

          return actions.order.create({
            purchase_units: [{
              amount: {
                currency_code: 'USD',
                value: total.toFixed(2)
              },
              description: 'Heart & Petal Gift Order'
            }]
          });
        },

        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            console.log('‚úÖ Payment captured:', details);

            // Prepare order data
            const cart = getCart();
            const orderData = {
              orderId: details.id,
              customerName: document.getElementById('checkout-name').value,
              customerEmail: document.getElementById('checkout-email').value,
              customerPhone: document.getElementById('checkout-phone').value,
              shippingAddress: document.getElementById('checkout-address').value,
              deliveryService: document.getElementById('checkout-shipping')?.value || 'Standard Delivery (3-5 days)',
              deliveryDate: document.getElementById('checkout-delivery-date')?.value || 'Not specified',
              specialInstructions: document.getElementById('checkout-notes').value,
              items: cart,
              subtotal: getCartTotal(),
              discount: parseFloat(localStorage.getItem('appliedDiscountAmount')) || 0,
              total: details.purchase_units[0].amount.value,
              paymentStatus: 'Completed',
              paymentMethod: 'PayPal',
              timestamp: new Date().toISOString()
            };

            // Save order
            if (typeof createOrder === 'function') {
              const saveResult = createOrder(orderData);
              console.log('üì¶ Order saved:', saveResult);
            }

            // Send confirmation email
            if (typeof emailjs !== 'undefined') {
              emailjs.send('service_qw61mye', 'heartandpetal_order', {
                to_email: orderData.customerEmail,
                customer_name: orderData.customerName,
                order_id: orderData.orderId,
                order_items: cart.map(item => `${item.name} (${item.quantity}x) - $${(item.price * item.quantity).toFixed(2)}`).join('\n'),
                order_total: `$${orderData.total}`,
                shipping_address: orderData.shippingAddress,
                delivery_service: orderData.deliveryService,
                delivery_date: orderData.deliveryDate
              }).then(
                () => console.log('‚úÖ Email sent'),
                (err) => console.error('‚ùå Email error:', err)
              );
            }

            // Clear cart
            localStorage.removeItem('cart');
            localStorage.removeItem('appliedDiscountCode');
            localStorage.removeItem('appliedDiscountAmount');

            // Redirect to tracking
            showSuccess(`Payment successful! Order ID: ${details.id}\n\nA confirmation email has been sent to ${orderData.customerEmail}`);
            window.location.href = `tracking.html?order=${details.id}`;
          });
        },

        onError: function(err) {
          console.error('‚ùå PayPal error:', err);
          showError('Payment failed. Please try again or contact support.');
        }

      }).render('#paypal-button-container');

      console.log('‚úÖ PayPal button rendered');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Checkout page loaded');
      
      // Display cart
      displayCheckoutCart();

      // Update cart count in header
      const cart = getCart();
      document.getElementById('cart-count').textContent = cart ? cart.reduce((sum, item) => sum + item.quantity, 0) : 0;

      // Initialize PayPal when SDK loads
      if (window.paypal) {
        initPayPalButton();
      } else {
        // Wait for SDK to load
        const checkPayPal = setInterval(() => {
          if (window.paypal) {
            clearInterval(checkPayPal);
            initPayPalButton();
          }
        }, 100);

        // Timeout after 10 seconds
        setTimeout(() => {
          if (!window.paypal) {
            clearInterval(checkPayPal);
            document.getElementById('paypal-error').classList.remove('hidden');
          }
        }, 10000);
      }
    });
  </script>

</body>
</html>
